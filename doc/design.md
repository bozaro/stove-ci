# Дизайн
## Обзор имеющихся решений
Здесь представлен субъективный перечень решений, которые используются в существующих CI.

### Jenkins
#### Jenkinsfile
В Jenkins есть два варианта описания сборки:

 - императивный (scripted pipeline);
 - декларативный (declarative pipeline).

Изначально в Jenkins появилось императивное описание сборки.

Так как единственный способ выяснить, что будет делать императивная сборка - выполнить её, появился ряд проблем:

 - объявление параметров в pipeline для корректного поведения должно быть исполнено до начала сборки (эта проблема
   закостылена тем, что изменение параметров в сборке влияет на следующую сборку);
 - визуализация сборки работает так себе: пока шаг не выполнится его нельзя отобразить (эта проблема закостылена
   тем, что происходит слияние схемы от текущей и предыдущей сборки);

Через некоторое время в Jenkins появилось декларативное описание сборки.

Теоретически оно могло решить имеющиеся проблемы, но:

 - в декларативной сборке не достаточно выразительности (например: фиксированный список stage-ей). Из-за этого иногда
   приходится возвращаться к императивной сборке, которая разительно отличается синтаксически;
 - декларативная сборка де-факто реализована поверх императивной, так что сохраняет все имеющиеся недостатки, хотя
   субъективно отображение декларативной сборки более корректно работает.

#### Тесты выполняются в Docker
Инкапсуляция сборочного/тестового окружения в Docker-контейнер позволяет:

 - переложить бремя управления окружением на людей, которые занимаются разработкой проекта, а не поддержкой CI;
 - разные проекты могут иметь разные тестовые окружения и они не конфликтуют между собой;
 - если Dockerfile лежит в репозитории с проектом, то это позволяет легко обновлять окружение вместе с кодом.

Из недостатков реализации стоит отметить:

 - отсутствие кэширования ранее собранных Dockerfile-окружений (из-за этого на каждом новом агенте первая сборка 
   занимает очень много времени);
 - нет встроенного управления каталогами, которые должны сохраняться между сборками (кэши);
 - нет простого способа запустить более одного сервиса (обходится через supervisord);

#### Snippet generator

### TeamCity
#### Разметка консольных логов
В TeamCity есть возможность разметить output для вывода
(https://www.jetbrains.com/help/teamcity/build-script-interaction-with-teamcity.html).

Это позволяет разделить вывод нескольких параллельно исполняемых потоков.

Из недостатков реализации надо отметить, что экранированный многострочный текст выглядит очень трудночитаемо.

#### Интеграция с тестами
TeamCity показывает в режиме реального времени результат выполнения тестов.

Так же в TeamCity очень приятные отчеты по времени выполнения тестов.

## Примеры выполняемых сценариев

## Базовые принципы релизации
### Акценты
### Термины
### Рецепты
